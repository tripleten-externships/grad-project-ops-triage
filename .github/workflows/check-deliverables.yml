name: Check Deliverables

on:
  workflow_dispatch:
    inputs:
      discipline:
        description: 'Discipline to check (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - frontend
          - backend
          - data-science
          - qa
          - bia
          - security
          - ux-design
          - ai-automation
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

jobs:
  check-all-deliverables:
    name: Check Deliverables - ${{ matrix.discipline }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        discipline:
          - frontend
          - backend
          - data-science
          - qa
          - bia
          - security
          - ux-design
          - ai-automation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Check deliverables for ${{ matrix.discipline }}
        id: check-deliverables
        run: |
          echo "Checking deliverables for ${{ matrix.discipline }}..."
          node scripts/check-deliverables.js ${{ matrix.discipline }} > deliverables-${{ matrix.discipline }}.txt 2>&1
          cat deliverables-${{ matrix.discipline }}.txt
        continue-on-error: true

      - name: Upload deliverables report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deliverables-report-${{ matrix.discipline }}
          path: deliverables-${{ matrix.discipline }}.txt
          retention-days: 30

      - name: Add to job summary
        if: always()
        run: |
          echo "## Deliverables Check: ${{ matrix.discipline }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat deliverables-${{ matrix.discipline }}.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  generate-summary:
    name: Generate Deliverables Summary
    runs-on: ubuntu-latest
    needs: check-all-deliverables
    if: always()
    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: deliverables-reports

      - name: Create overall summary
        run: |
          echo "# ðŸ“‹ Deliverables Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated on: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results by Discipline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for dir in deliverables-reports/deliverables-report-*; do
            if [ -d "$dir" ]; then
              discipline=$(basename "$dir" | sed 's/deliverables-report-//')
              echo "### $discipline" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat "$dir"/*.txt 2>/dev/null | head -20 || echo "No report generated"
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Full reports are available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

  check-single-discipline:
    name: Check Single Discipline
    runs-on: ubuntu-latest
    if: github.event.inputs.discipline != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Check deliverables for ${{ github.event.inputs.discipline }}
        run: |
          echo "Checking deliverables for ${{ github.event.inputs.discipline }}..."
          node scripts/check-deliverables.js ${{ github.event.inputs.discipline }}

      - name: Add to job summary
        if: always()
        run: |
          echo "## Deliverables Check: ${{ github.event.inputs.discipline }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check completed - see logs above for details" >> $GITHUB_STEP_SUMMARY
